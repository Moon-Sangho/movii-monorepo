name: Deploy Movii to EC2 (self-hosted)

on:
  push:
    branches: [main]
    paths:
      - 'apps/movii/**'

  # 수동 배포 트리거
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual deploy reason (optional)'
        required: false

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify toolchain
        run: |
          set -e
          echo "whoami: $(whoami)"
          echo "node: $(node -v)"
          echo "pnpm: $(pnpm -v)"
          echo "pm2: $(pm2 -v)"

      - name: Deploy from ~/apps/movii
        env:
          VITE_TMDB_API_ACCESS_TOKEN: ${{ secrets.TMDB_API_ACCESS_TOKEN }}
        run: |
          set -e

          cd ~/apps/movii

          echo "➡️ Sync repo to origin/main"
          git fetch origin main
          git reset --hard origin/main
          git clean -fd

          echo "➡️ Install deps"
          pnpm install --frozen-lockfile

          echo "➡️ Build"
          pnpm build

          echo "➡️ Restart (PM2)"
          if pm2 describe movii >/dev/null 2>&1; then
            pm2 restart movii
          else
            cd apps/movii
            PORT=3000 NODE_ENV=production pm2 start server.js --name movii
          fi
          pm2 save

      - name: Health check (wait & retry)
        run: |
          set -e

          echo "Wait for app on :3000 ..."
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:3000 >/dev/null; then
              echo "OK: app is ready on :3000"
              break
            fi
            echo "not ready yet ($i/30) ..."; sleep 1
            if [ "$i" -eq 30 ]; then
              echo "FAIL: app not ready on :3000"
              pm2 status || true
              pm2 logs movii --lines 120 || true
              exit 1
            fi
          done

          echo "Check Nginx on :80 ..."
          for i in {1..10}; do
            if curl -fsS http://127.0.0.1/ >/dev/null; then
              echo "OK: Nginx is serving Movii on :80"
              exit 0
            fi
            echo "nginx not ready yet ($i/10) ..."; sleep 1
          done

          echo "FAIL: Nginx still not serving on :80"
          sudo tail -n 120 /var/log/nginx/error.log || true
          exit 1
